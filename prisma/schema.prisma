// Prisma schema for EcoMetrics Sustainability Platform
// AI-first sustainability tracking, carbon footprint monitoring, and ESG reporting

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  ADMIN
  SUSTAINABILITY_MANAGER
  ANALYST
  VIEWER
}

enum OrganizationType {
  ENTERPRISE
  SMB
  STARTUP
  NON_PROFIT
  GOVERNMENT
}

enum EmissionScope {
  SCOPE_1    // Direct emissions
  SCOPE_2    // Indirect emissions from purchased energy
  SCOPE_3    // Other indirect emissions in value chain
}

enum EmissionCategory {
  // Scope 1
  STATIONARY_COMBUSTION
  MOBILE_COMBUSTION
  FUGITIVE_EMISSIONS
  PROCESS_EMISSIONS
  
  // Scope 2
  PURCHASED_ELECTRICITY
  PURCHASED_HEAT
  PURCHASED_STEAM
  
  // Scope 3
  PURCHASED_GOODS_SERVICES
  CAPITAL_GOODS
  FUEL_ENERGY_ACTIVITIES
  UPSTREAM_TRANSPORTATION
  WASTE_GENERATED
  BUSINESS_TRAVEL
  EMPLOYEE_COMMUTING
  UPSTREAM_LEASED_ASSETS
  DOWNSTREAM_TRANSPORTATION
  PROCESSING_SOLD_PRODUCTS
  USE_SOLD_PRODUCTS
  END_OF_LIFE_TREATMENT
  DOWNSTREAM_LEASED_ASSETS
  FRANCHISES
  INVESTMENTS
}

enum DataQuality {
  MEASURED      // Direct measurement
  CALCULATED    // Calculated from primary data
  ESTIMATED     // Estimated using industry averages
  PROXY         // Proxy data from similar sources
}

enum GoalStatus {
  DRAFT
  ACTIVE
  ACHIEVED
  MISSED
  CANCELLED
}

enum ReportType {
  CARBON_FOOTPRINT
  ESG_COMPREHENSIVE
  GRI_STANDARD
  SASB_STANDARD
  TCFD_STANDARD
  CDP_CLIMATE
  CUSTOM
}

enum ReportStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  PUBLISHED
}

enum AuditEventType {
  USER_LOGIN
  USER_LOGOUT
  DATA_CREATE
  DATA_UPDATE
  DATA_DELETE
  DATA_EXPORT
  REPORT_GENERATE
  GOAL_CREATE
  GOAL_UPDATE
  AI_QUERY
  API_ACCESS
  PERMISSION_CHANGE
}

enum IntegrationType {
  API
  CSV_UPLOAD
  EXCEL_UPLOAD
  ERP_SYSTEM
  IOT_SENSOR
  CLOUD_PROVIDER
  UTILITY_PROVIDER
}

// =============================================================================
// USER & ORGANIZATION MODELS
// =============================================================================

model Organization {
  id                String           @id @default(uuid())
  name              String
  type              OrganizationType
  industry          String?
  country           String
  employeeCount     Int?
  annualRevenue     Decimal?         @db.Decimal(15, 2)
  website           String?
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  users             User[]
  facilities        Facility[]
  emissionRecords   EmissionRecord[]
  goals             SustainabilityGoal[]
  reports           Report[]
  suppliers         Supplier[]
  auditLogs         AuditLog[]
  aiInteractions    AIInteraction[]
  
  @@index([name])
}

model User {
  id                String           @id @default(uuid())
  email             String           @unique
  name              String
  role              UserRole         @default(VIEWER)
  organizationId    String
  
  // Authentication
  passwordHash      String?
  lastLogin         DateTime?
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  emissionRecords   EmissionRecord[]
  reports           Report[]
  aiInteractions    AIInteraction[]
  auditLogs         AuditLog[]
  
  @@index([organizationId])
  @@index([email])
}

// =============================================================================
// FACILITY & LOCATION MODELS
// =============================================================================

model Facility {
  id                String           @id @default(uuid())
  organizationId    String
  name              String
  address           String
  city              String
  state             String?
  country           String
  postalCode        String?
  
  // Geo coordinates for location-based carbon intensity
  latitude          Decimal?         @db.Decimal(10, 8)
  longitude         Decimal?         @db.Decimal(11, 8)
  
  // Facility details
  facilityType      String?          // e.g., "office", "warehouse", "factory"
  squareMeters      Decimal?         @db.Decimal(10, 2)
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  emissionRecords   EmissionRecord[]
  
  @@index([organizationId])
}

// =============================================================================
// EMISSION TRACKING MODELS
// =============================================================================

model EmissionRecord {
  id                String           @id @default(uuid())
  organizationId    String
  facilityId        String?
  userId            String
  
  // Emission details
  scope             EmissionScope
  category          EmissionCategory
  activityData      Decimal          @db.Decimal(15, 4)  // e.g., kWh, liters, km
  activityUnit      String           // e.g., "kWh", "L", "km"
  emissionFactor    Decimal          @db.Decimal(15, 6)  // kg CO2e per unit
  emissionFactorSource String?       // Source of emission factor
  totalEmissions    Decimal          @db.Decimal(15, 4)  // kg CO2e
  
  // Data quality & source
  dataQuality       DataQuality
  source            String?          // Description of data source
  referenceNumber   String?          // External reference (invoice #, etc.)
  
  // Time period
  startDate         DateTime
  endDate           DateTime
  
  // Additional details
  description       String?
  notes             String?
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  facility          Facility?        @relation(fields: [facilityId], references: [id])
  user              User             @relation(fields: [userId], references: [id])
  
  @@index([organizationId])
  @@index([facilityId])
  @@index([scope])
  @@index([category])
  @@index([startDate, endDate])
}

// =============================================================================
// SUSTAINABILITY GOALS & TARGETS
// =============================================================================

model SustainabilityGoal {
  id                String           @id @default(uuid())
  organizationId    String
  
  // Goal details
  name              String
  description       String?
  scope             EmissionScope?   // null means all scopes
  
  // Targets
  baselineYear      Int
  baselineValue     Decimal          @db.Decimal(15, 4)  // kg CO2e
  targetYear        Int
  targetValue       Decimal          @db.Decimal(15, 4)  // kg CO2e
  reductionPercent  Decimal          @db.Decimal(5, 2)   // e.g., 50.00 for 50%
  
  // Status
  status            GoalStatus       @default(ACTIVE)
  currentValue      Decimal?         @db.Decimal(15, 4)  // Current emissions
  progressPercent   Decimal?         @db.Decimal(5, 2)   // Progress toward goal
  
  // AI insights
  aiRecommendations String?          // AI-generated recommendations
  predictedAchievementDate DateTime?
  riskLevel         String?          // "low", "medium", "high"
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([status])
  @@index([targetYear])
}

// =============================================================================
// SUPPLY CHAIN MODELS
// =============================================================================

model Supplier {
  id                String           @id @default(uuid())
  organizationId    String
  
  // Supplier information
  name              String
  country           String
  industry          String?
  
  // Sustainability scoring
  sustainabilityScore Decimal?       @db.Decimal(5, 2)  // 0-100
  carbonIntensity   Decimal?         @db.Decimal(15, 6) // kg CO2e per $
  lastAssessmentDate DateTime?
  
  // Certifications
  certifications    String[]         // e.g., ["ISO 14001", "B Corp"]
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Relations
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
}

// =============================================================================
// REPORTING MODELS
// =============================================================================

model Report {
  id                String           @id @default(uuid())
  organizationId    String
  userId            String
  
  // Report details
  reportType        ReportType
  title             String
  description       String?
  
  // Time period
  startDate         DateTime
  endDate           DateTime
  
  // Status
  status            ReportStatus     @default(DRAFT)
  
  // Content
  content           Json?            // Report data in JSON format
  fileUrl           String?          // URL to generated PDF/document
  
  // AI generation
  aiGenerated       Boolean          @default(false)
  aiPrompt          String?
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  publishedAt       DateTime?
  
  // Relations
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id])
  
  @@index([organizationId])
  @@index([reportType])
  @@index([status])
  @@index([startDate, endDate])
}

// =============================================================================
// AI INTERACTION MODELS
// =============================================================================

model AIInteraction {
  id                String           @id @default(uuid())
  organizationId    String
  userId            String
  
  // Query details
  query             String           // Natural language query
  queryType         String           // "insight", "forecast", "recommendation", etc.
  
  // AI response
  response          String
  confidence        Decimal?         @db.Decimal(5, 4)  // 0-1 confidence score
  
  // Processing details
  provider          String           // "openai", "anthropic"
  model             String           // "gpt-4", "claude-3-opus", etc.
  tokensUsed        Int?
  processingTimeMs  Int?
  
  // Timestamps
  createdAt         DateTime         @default(now())
  
  // Relations
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [userId], references: [id])
  
  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
}

// =============================================================================
// AUDIT & COMPLIANCE MODELS
// =============================================================================

model AuditLog {
  id                String           @id @default(uuid())
  organizationId    String
  userId            String?
  
  // Event details
  eventType         AuditEventType
  resourceType      String?          // "emission_record", "goal", "report", etc.
  resourceId        String?
  action            String
  
  // Context
  ipAddress         String?
  userAgent         String?
  metadata          Json?            // Additional event-specific data
  
  // Timestamp
  createdAt         DateTime         @default(now())
  
  // Relations
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User?            @relation(fields: [userId], references: [id])
  
  @@index([organizationId])
  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
}

// =============================================================================
// INTEGRATION MODELS
// =============================================================================

model Integration {
  id                String           @id @default(uuid())
  organizationId    String
  
  // Integration details
  name              String
  type              IntegrationType
  provider          String?          // e.g., "SAP", "Salesforce", "AWS"
  
  // Configuration
  config            Json             // Integration-specific configuration
  credentials       String?          // Encrypted credentials
  
  // Status
  enabled           Boolean          @default(true)
  lastSyncAt        DateTime?
  nextSyncAt        DateTime?
  
  // Timestamps
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([organizationId])
}
